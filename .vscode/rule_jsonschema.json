{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Panther Rule",
  "description": "A Detection for security events which is based on log data",

  "type": "object",
  "properties": {
    "AlertContext": {
      "$ref": "#/definitions/AlertContext"
    },
    "AlertTitle": {
      "$ref": "#/definitions/AlertTitle"
    },
    "AnalysisType": {
      "$ref": "#/definitions/AnalysisType"
    },
    "DisplayName": {
      "$ref": "#/definitions/DisplayName"
    },
    "Enabled": {
      "$ref": "#/definitions/Enabled"
    },
    "CreateAlert": {
      "$ref": "#/definitions/CreateAlert"
    },
    "Filename": {
      "$ref": "#/definitions/Filename"
    },
    "InlineFilters": {
      "$ref": "#/definitions/InlineFilters"
    },
    "Detection": {
      "$ref": "#/definitions/Detection"
    },
    "RuleID": {
      "$ref": "#/definitions/RuleID"
    },
    "Severity": {
      "$ref": "#/definitions/Severity"
    },
    "Tests": {
      "type": "array",
      "items": { "$ref": "#/definitions/UnitTestCase" }
    },
    "Description": {
      "$ref": "#/definitions/Description"
    },
    "LogTypes": {
      "$ref": "#/definitions/LogTypes"
    },
    "Tags": {
      "$ref": "#/definitions/Tags"
    },
    "Runbook": {
      "$ref": "#/definitions/Runbook"
    },
    "SummaryAttributes": {
      "$ref": "#/definitions/SummaryAttributes"
    },
    "DedupPeriodMinutes": {
      "$ref": "#/definitions/DedupPeriodMinutes"
    },
    "Reports": {
      "$ref": "#/definitions/Reports"
    },
    "Reference": {
      "$ref": "#/definitions/Reference"
    },
    "Threshold": {
      "$ref": "#/definitions/Threshold"
    },
    "ScheduledQueries": {
      "$ref": "#/definitions/ScheduledQueries"
    }
  },
  "required": ["AnalysisType", "DisplayName", "Enabled", "RuleID", "Severity"],
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": { "AnalysisType": { "enum": ["rule", "scheduled_rule"] } }
      },
      "then": {
        "required": ["Tests"]
      }
    }
  ],
  "anyOf": [
    {
      "required": ["Filename"]
    },
    {
      "required": ["Detection"]
    }
  ],
  "definitions": {
    "AlertContext": {
      "$comment": "https://docs.panther.com/detections/rules/writing-simple-detections#alertcontext",
      "description": "Event values to add to the Event under custom keys to create dynamic alert context",
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "KeyName": {
            "type": "string",
            "description": "Defined name of field in the alert_context"
          },
          "KeyValue": {
            "type": "object",
            "properties": {
              "Key": {
                "type": "string",
                "description": "Name of top-level event field"
              },
              "KeyPath": {
                "type": "string",
                "description": "Path to nested event field, using '.' to denote subfields"
              },
              "DeepKey": {
                "type": "array",
                "description": "Path to nested event field, with each subfield a separate array item",
                "items": {
                  "type": "string"
                }
              }
            },
            "oneOf": [
              {
                "required": ["Key"],
                "not": {"required": ["KeyPath", "DeepKey"]}
              },
              {
                "required": ["KeyPath"],
                "not": {"required": ["Key", "DeepKey"]}
              },
              {
                "required": ["DeepKey"],
                "not": {"required": ["Key", "KeyPath"]}
              }
            ]
          }
        }
      }
    },
    "AlertTitle": {
      "$comment": "https://docs.panther.com/detections/rules/writing-simple-detections#alerttitle",
      "description": "Use AlertTitle to dynamically set the title of an alert generated by a match on this detection.",
      "type": "string",
      "default": "rule"
    },
    "AnalysisType": {
      "description": "what kind of detection",
      "type": "string",
      "enum": ["rule", "scheduled_rule", "correlation_rule"],
      "default": "rule"
    },
    "DisplayName": {
      "description": "A DisplayName of the detection",
      "default": "A human friendly name for your detection",
      "type": "string",
      "minLength": 1
    },
    "Enabled": {
      "description": "Should this rule run automatically",
      "type": "boolean",
      "default": true
    },
    "CreateAlert": {
      "description": "Whether the correlation rule should create an alert or not (default: true)",
      "type": "boolean",
      "default": true
    },
    "Filename": {
      "title": "Filename to the python file that acommpanies this detection.",
      "description": "Python file with the detection logic",
      "type": "string",
      "default": "this_file.py"
    },
    "RuleID": {
      "$comment": "https://docs.panther.com/detections/rules/python#python-rule-specification-reference",
      "description": "A unique string to identify this rule",
      "default": "LogType.DetectionClassification.Specific",
      "type": "string"
    },
    "Description": {
      "$comment": "https://docs.panther.com/detections/rules/python#python-rule-specification-reference",
      "description": "Description is a short sentence that describes what the detection detects.",
      "type": "string"
    },
    "InlineFilters": {
      "$comment": "https://docs.panther.com/detections/rules/inline-filters#creating-filters-in-the-cli-workflow",
      "description": "Simple filters pre-applied to a rule's logic",
      "type": "array",
      "items": {
        "$ref": "#/definitions/InlineFilterMatchDefinition"
      }
    },
    "Detection": {
      "$comment": "https://docs.panther.com/detections/rules/writing-simple-detections#detection",
      "description": "Panther Simple Detection rule in YAML format",
      "type": "array"
    },
    "DedupPeriodMinutes": {
      "$comment": "https://docs.panther.com/detections/rules/python#python-rule-specification-reference",
      "description": "A number of minutes to supress additional alerts, based on the output of the dedup function",
      "type": "integer"
    },
    "Reference": {
      "$comment": "https://docs.panther.com/detections/rules/python#python-rule-specification-reference",
      "description": "Reference material for alert. This might be a description or a link",
      "type": "string"
    },
    "Reports": {
      "$comment": "https://docs.panther.com/detections/rules/python#python-rule-specification-reference",
      "description": "Reports describe which Benchmarks might apply to the detection, like CIS or ATT&CK",
      "type": "object"
    },
    "ScheduledQueries": {
      "$comment": "Which scheduled queries feed input to this rule",
      "description": "Scheduled Query IDs",
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "Severity": {
      "$comment": "What severity should emitted alerts possess?",
      "description": "Alert severity",
      "default": "Medium",
      "type": "string",
      "enum": ["Info", "Low", "Medium", "High", "Critical"]
    },
    "Threshold": {
      "$comment": "How many events should match this rule before an alert is fired",
      "description": "Threshold of event matches before alerting",
      "default": 1,
      "type": "integer"
    },
    "SummaryAttributes": {
      "$comment": "Enter the attributes you want to showcase in the alerts that are triggered by this detection",
      "description": "Enter the attributes you want to showcase in the alerts that are triggered by this detection",
      "type": "array",
      "items": [{ "type": "string" }]
    },
    "Tags": {
      "$comment": "Enter custom tags to help you understand the rule at a glance",
      "description": "Enter custom tags to help you understand the rule at a glance",
      "type": "array",
      "items": [{ "type": "string" }]
    },
    "LogTypes": {
      "id": "LogTypes",
      "description": "which log types should this work against",
      "type": "array",
      "items": [{ "type": "string" }],
      "minItems": 1
    },
    "Runbook": {
      "$comment": "https://docs.panther.com/detections/rules/python#python-rule-specification-reference",
      "description": "Runbook instructions go here",
      "default": "What should people do when this alert fires?",
      "type": "string",
      "minLength": 1
    },
    "RuleMatch": {
      "$comment": "https://docs.panther.com/detections/correlation-rules/correlation-rule-reference#ruleoutput-fields",
      "description": "The Match that occurred for 1 of the rules in this test case",
      "type": "object",
      "required": ["ID"],
      "properties": {
        "ID": {
          "type": "string",
          "description": "The ID of the Rule from the Sequence/Group section above to simulate matches on"
        },
        "Matches": {
          "type": "object",
          "description": "The Match definition for this rule. Key: field that matched. value: mapping of the value that was matched on to the timestamps that the match(es) occurred. See docs for more details",
          "$comment": "https://docs.panther.com/detections/correlation-rules/correlation-rule-reference#matchvalue-fields"
        }
      }
    },
    "MatchExpressionCondition": {
      "$comment": "https://docs.panther.com/detections/rules/writing-simple-detections/match-expression#condition",
      "description": "Apply a condition operation between a log field and a value",
      "type": "string",
      "enum": [
        "Exists",
        "DoesNotExist",
        "IsNull",
        "IsNotNull",
        "IsNullOrEmpty",
        "IsNotNullOrEmpty",
        "Equals",
        "DoesNotEqual",
        "IEquals",
        "IDoesNotEqual",
        "StartsWith",
        "IStartsWith",
        "DoesNotStartWith",
        "IDoesNotStartWith",
        "EndsWith",
        "IEndsWith",
        "DoesNotEndWith",
        "IDoesNotEndWith",
        "Contains",
        "IContains",
        "DoesNotContain",
        "IDoesNotContain",
        "IsIPAddres",
        "IsIPv4Address",
        "IsIPv6Address",
        "IsIPAddressPrivate",
        "IsIPAddressPublic",
        "IsIPAddressInCIDR",
        "IsIPAddressNotInCIDR",
        "CIDRContainsIPAddresses",
        "CIDRDoesNotContainIPAddresses",
        "IsGreaterThan",
        "IsGreaterThanOrEqual",
        "IsLessThan",
        "IsLessThanOrEqual",
        "IsIn",
        "IsNotIn",
        "AnyElement",
        "AllElements",
        "OnlyOneElement",
        "NoElement"
      ]
    },
    "MatchExpressionValue": {
      "$comment": "https://docs.panther.com/detections/rules/writing-simple-detections/match-expression#value-s",
      "type": ["number", "boolean", "string"]
    },
    "InlineFilterMatchDefinition": {
      "type": "object",
      "properties": {
        "KeyPath": {
          "type": "string",
          "description": "Specify a log field, usind '.' to access nested subfields and [] to access array items."
        },
        "Condition": {
          "$ref": "#/definitions/MatchExpressionCondition"
        },
        "Value": {
          "$ref": "#/definitions/MatchExpressionValue",
          "description": "Value to compare to field in log."
        },
        "All": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/InlineFilterMatchDefinition"
          }
        },
        "Any": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/InlineFilterMatchDefinition"
          }
        }
      },
      "oneOf": [
        {
          "required": ["KeyPath", "Condition", "Value"],
          "not": {"required": ["All", "Any"]}
        },
        { 
          "required": ["Any"],
          "not": {"required": ["KeyPath", "Condition", "Value", "All"]}
        },
        { 
          "required": ["All"],
          "not": {"required": ["KeyPath", "Condition", "Value", "Any"]}
        }
      ]
    },
    "Tests": {
      "$comment": "https://docs.panther.com/detections/testing#how-to-create-a-test-in-the-cli-workflow",
      "description": "Unit test cases",
      "type": "array",
      "items": { "$ref": "#/definitions/UnitTestCase" }
    },
    "UnitTestCase": {
      "type": "object",
      "properties": {
        "Name": {
          "type": "string",
          "default": "Unit test case name"
        },
        "ExpectedResult": {
          "type": "boolean",
          "$comment": "If this test case should alert or not",
          "description": "true for Alert, false for NotAlert.",
          "default": true
        },
        "Log": {
          "anyOf": [
            {
              "if": {
                "properties": { "AnalysisType": { "enum": ["rule"] } }
              },
              "then": {
                "type": "object",
                "comment": "A log entry, json or yaml formatted",
                "description": "the log data"
              },
              "else": false
            }
          ]
        },
        "Resource": {
          "anyOf": [
            {
              "if": {
                "properties": { "AnalysisType": { "enum": ["scheduled_rule"] } }
              },
              "then": {
                "type": "object",
                "comment": "A resource definition entry, json or yaml formatted",
                "description": "the resource data"
              },
              "else": false
            }
          ]
        },
        "RuleOutputs": {
          "anyOf": [
            {
              "if": {
                "properties": {
                  "AnalysisType": { "enum": ["correlation_rule"] }
                }
              },
              "then": {
                "type": "array",
                "description": "List of Rule Matches that occurred for this test case",
                "items": { "$ref": "#/definitions/RuleMatch" },
                "minItems": 1
              },
              "else": false
            }
          ]
        }
      },
      "oneOf": [
        {
          "if": {
            "properties": { "AnalysisType": { "enum": ["rule"] } }
          },
          "then": {
            "required": ["Name", "ExpectedResult", "Log"]
          }
        },
        {
          "if": {
            "properties": { "AnalysisType": { "enum": ["correlation_rule"] } }
          },
          "then": {
            "required": ["Name", "ExpectedResult", "RuleOutputs"]
          }
        }
      ]
    }
  }
}
