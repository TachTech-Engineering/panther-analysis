AnalysisType: rule
Description: "Detects creation and updates of the list of trusted IPs used by GuardDuty and WAF. Potentially to disable security alerts against malicious IPs."
DisplayName: "AWS Trusted IPSet Modified"
Enabled: true
Filename: aws_ipset_modified.py
Reports:
  MITRE ATT&CK:
    - TA0005:T1562
Reference: https://docs.aws.amazon.com/managedservices/latest/ctref/management-monitoring-guardduty-ip-set-update-review-required.html
Severity: High
Tests:
  - ExpectedResult: true
    Name: CreateIPSet Event
    Log:
      {
        "awsRegion": "us-east-1",
        "eventId": "abc-123",
        "eventName": "CreateIPSet",
        "eventSource": "guardduty.amazonaws.com",
        "eventTime": "2022-07-17 04:50:23",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "p_any_aws_instance_ids": ["testinstanceid"],
        "p_event_time": "2022-07-17 04:50:23",
        "p_log_type": "AWS.CloudTrail",
        "p_parse_time": "2022-07-17 04:55:11.788",
        "recipientAccountId": "123456789012",
      }
  - ExpectedResult: true
    Name: UpdateIPSet
    Log:
      {
        "awsRegion": "us-east-1",
        "eventId": "abc-123",
        "eventName": "CreateIPSet",
        "eventSource": "guardduty.amazonaws.com",
        "eventTime": "2022-07-17 04:50:23",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "p_any_aws_instance_ids": ["testinstanceid"],
        "p_event_time": "2022-07-17 04:50:23",
        "p_log_type": "AWS.CloudTrail",
        "p_parse_time": "2022-07-17 04:55:11.788",
        "recipientAccountId": "123456789012",
      }
  - ExpectedResult: false
    Name: NotIPSet
    Log:
      {
        "awsRegion": "us-east-1",
        "eventId": "abc-123",
        "eventName": "ModifyInstanceAttributes",
        "eventSource": "guardduty.amazonaws.com",
        "eventTime": "2022-07-17 04:50:23",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "p_any_aws_instance_ids": ["testinstanceid"],
        "p_event_time": "2022-07-17 04:50:23",
        "p_log_type": "AWS.CloudTrail",
        "p_parse_time": "2022-07-17 04:55:11.788",
        "recipientAccountId": "123456789012",
      }
  - ExpectedResult: true
    Name: UpdateIPSet - OCSF
    Log:
      {
        "api":
          {
            "operation": "CreateIPSet",
            "service": { "name": "guardduty.amazonaws.com" },
          },
        "actor":
          {
            "user": { "uid": "arn:aws:sts::123456789012:assumed-role/tester" },
          },
        "cloud": { "provider": "AWS", "region": "us-east-2" },
        "src_endpoint": { "ip": "111.111.111.111" },
        "unmapped": { "recipientAccountId": "123456789012" },
        "p_log_type": "OCSF.ApiActivity",
      }
  - ExpectedResult: false
    Name: NotIPSet - OCSF
    Log:
      {
        "api":
          {
            "operation": "ModifyInstanceAttributes",
            "service": { "name": "guardduty.amazonaws.com" },
          },
        "actor":
          {
            "user": { "uid": "arn:aws:sts::123456789012:assumed-role/tester" },
          },
        "cloud": { "provider": "AWS", "region": "us-east-2" },
        "src_endpoint": { "ip": "111.111.111.111" },
        "unmapped": { "recipientAccountId": "123456789012" },
        "p_log_type": "OCSF.ApiActivity",
      }
DedupPeriodMinutes: 60
LogTypes:
  - AWS.CloudTrail
  - OCSF.ApiActivity
Tags:
  - DataModel
RuleID: "AWS.IPSet.Modified"
Threshold: 1
