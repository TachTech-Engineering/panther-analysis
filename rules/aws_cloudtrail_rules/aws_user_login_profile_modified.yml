AnalysisType: rule
Description: "An attacker with iam:UpdateLoginProfile permission on other users can change the password used to login to the AWS console. May be legitimate account administration."
DisplayName: "AWS User Login Profile Modified"
Enabled: true
Filename: aws_user_login_profile_modified.py
Reports:
  MITRE ATT&CK:
    - TA0003:T1098
    - TA0005:T1108
    - TA0005:T1550
    - TA0008:T1550
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_aws_my-sec-creds-self-manage-pass-accesskeys-ssh.html
Severity: High
Tests:
  - ExpectedResult: false
    Name: ChangeOwnPassword
    Log:
      {
        "awsRegion": "us-east-1",
        "eventCategory": "Management",
        "eventID": "1234",
        "eventName": "UpdateLoginProfile",
        "eventSource": "iam.amazonaws.com",
        "eventTime": "2022-09-15 13:45:24",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "managementEvent": true,
        "readOnly": false,
        "recipientAccountId": "987654321",
        "requestParameters":
          { "passwordResetRequired": false, "userName": "alice" },
        "sessionCredentialFromConsole": true,
        "sourceIPAddress": "AWS Internal",
        "userAgent": "AWS Internal",
        "userIdentity":
          {
            "accessKeyId": "ABC1234",
            "accountId": "987654321",
            "arn": "arn:aws:sts::98765432:assumed-role/IAM/alice",
            "principalId": "ABCDE:alice",
            "sessionContext":
              {
                "attributes":
                  {
                    "creationDate": "2022-09-15T13:36:47Z",
                    "mfaAuthenticated": "true",
                  },
                "sessionIssuer":
                  {
                    "accountId": "987654321",
                    "arn": "arn:aws:iam::9876432:role/IAM",
                    "principalId": "1234ABC",
                    "type": "Role",
                    "userName": "IAM",
                  },
                "webIdFederationData": {},
              },
            "type": "AssumedRole",
          },
        "p_log_type": "AWS.CloudTrail",
      }
  - ExpectedResult: true
    Name: User changed password for other
    Log:
      {
        "awsRegion": "us-east-1",
        "eventCategory": "Management",
        "eventID": "1234",
        "eventName": "UpdateLoginProfile",
        "eventSource": "iam.amazonaws.com",
        "eventTime": "2022-09-15 13:45:24",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "managementEvent": true,
        "readOnly": false,
        "recipientAccountId": "987654321",
        "requestParameters":
          { "passwordResetRequired": false, "userName": "bob" },
        "sessionCredentialFromConsole": true,
        "sourceIPAddress": "AWS Internal",
        "userAgent": "AWS Internal",
        "userIdentity":
          {
            "accessKeyId": "ABC1234",
            "accountId": "987654321",
            "arn": "arn:aws:sts::98765432:assumed-role/IAM/alice",
            "principalId": "ABCDE:alice",
            "sessionContext":
              {
                "attributes":
                  {
                    "creationDate": "2022-09-15T13:36:47Z",
                    "mfaAuthenticated": "true",
                  },
                "sessionIssuer":
                  {
                    "accountId": "987654321",
                    "arn": "arn:aws:iam::9876432:role/IAM",
                    "principalId": "1234ABC",
                    "type": "Role",
                    "userName": "IAM",
                  },
                "webIdFederationData": {},
              },
            "type": "AssumedRole",
          },
        "p_log_type": "AWS.CloudTrail",
      }
  - ExpectedResult: false
    Name: User changed password for other reset required
    Log:
      {
        "awsRegion": "us-east-1",
        "eventCategory": "Management",
        "eventID": "1234",
        "eventName": "UpdateLoginProfile",
        "eventSource": "iam.amazonaws.com",
        "eventTime": "2022-09-15 13:45:24",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "managementEvent": true,
        "readOnly": false,
        "recipientAccountId": "987654321",
        "requestParameters":
          { "passwordResetRequired": true, "userName": "bob" },
        "sessionCredentialFromConsole": true,
        "sourceIPAddress": "AWS Internal",
        "userAgent": "AWS Internal",
        "userIdentity":
          {
            "accessKeyId": "ABC1234",
            "accountId": "987654321",
            "arn": "arn:aws:sts::98765432:assumed-role/IAM/alice",
            "principalId": "ABCDE:alice",
            "sessionContext":
              {
                "attributes":
                  {
                    "creationDate": "2022-09-15T13:36:47Z",
                    "mfaAuthenticated": "true",
                  },
                "sessionIssuer":
                  {
                    "accountId": "987654321",
                    "arn": "arn:aws:iam::9876432:role/IAM",
                    "principalId": "1234ABC",
                    "type": "Role",
                    "userName": "IAM",
                  },
                "webIdFederationData": {},
              },
            "type": "AssumedRole",
          },
        "p_log_type": "AWS.CloudTrail",
      }
  - ExpectedResult: false
    Name: ChangeOwnPassword - OCSF
    Log:
      {
        "api":
          {
            "operation": "UpdateLoginProfile",
            "service": { "name": "iam.amazonaws.com" },
            "request": {"data": "{\"userName\":\"alice\", \"passwordResetRequired\":false}",}
          },
        "actor":
          {
            "user":
              {
                "type": "AssumedRole",
                "uid": "arn:aws:sts::98765432:assumed-role/IAM/alice",
              },
          },
        "unmapped":
          {
            "recipientAccountId": "123456789012",
          },
        "p_log_type": "OCSF.AccountChange",
      }
  - ExpectedResult: true
    Name: User changed password for other - OCSF
    Log:
      {
        "api":
          {
            "operation": "UpdateLoginProfile",
            "service": { "name": "iam.amazonaws.com" },
            "request": {"data": "{\"userName\":\"bob\", \"passwordResetRequired\":false}",}
          },
        "actor":
          {
            "user":
              {
                "type": "AssumedRole",
                "uid": "arn:aws:sts::98765432:assumed-role/IAM/alice",
              },
          },
        "unmapped":
          {
            "recipientAccountId": "123456789012",
          },
        "p_log_type": "OCSF.AccountChange",
      }
DedupPeriodMinutes: 60
LogTypes:
  - AWS.CloudTrail
  - OCSF.AccountChange
Tags:
  - DataModel
RuleID: "AWS.User.Login.Profile.Modified"
Threshold: 1
