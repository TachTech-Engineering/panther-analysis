AnalysisType: rule
Description: This detection looks for *AccountPasswordPolicy events in AWS CloudTrail logs. If these events occur in a short period of time from the same ARN, it could constitute Password Policy reconnaissance.
DisplayName: AWS CloudTrail Password Policy Discovery
Enabled: true
Filename: aws_cloudtrail_password_policy_discovery.py
Reports:
  MITRE ATT&CK:
    - TA0007:T1201
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_passwords_account-policy.html
Severity: Info
Tests:
  - ExpectedResult: false
    Name: Non-Discovery Event
    Log:
      {
        "apiVersion": "2012-08-10",
        "awsRegion": "eu-west-1",
        "eventCategory": "Data",
        "eventId": "5d4b45ed-a15c-41b6-80e9-031729fa060d",
        "eventName": "GetRecords",
        "eventSource": "dynamodb.amazonaws.com",
        "eventTime": "2023-01-10 21:04:02",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "managementEvent": false,
        "userIdentity": { "arn": "arn:aws:test_arn" },
        "p_log_type": "AWS.CloudTrail",
      }
  - ExpectedResult: true
    Name: Password Discovery ARN
    Log:
      {
        "awsRegion": "us-east-1",
        "eventCategory": "Management",
        "eventId": "1808ca3b-4311-4b48-9d1f-21061acb2329",
        "eventName": "GetAccountPasswordPolicy",
        "eventSource": "iam.amazonaws.com",
        "eventTime": "2023-01-10 23:10:06",
        "eventType": "AwsApiCall",
        "eventVersion": "1.08",
        "managementEvent": true,
        "userIdentity": { "arn": "arn:aws:test_arn" },
        "p_log_type": "AWS.CloudTrail",
      }
  - ExpectedResult: false
    Name: Password Discovery Service
    Log:
      {
        "awsRegion": "us-east-1",
        "eventType": "AwsServiceEvent",
        "eventCategory": "Management",
        "eventId": "1808ca3b-4311-4b48-9d1f-21061acb2329",
        "eventName": "GetAccountPasswordPolicy",
        "eventSource": "iam.amazonaws.com",
        "eventTime": "2023-01-10 23:10:06",
        "eventVersion": "1.08",
        "managementEvent": true,
        "p_log_type": "AWS.CloudTrail",
      }
  - ExpectedResult: false
    Name: Non-Discovery Event - OCSF
    Log:
      {
        "api":
          {
            "operation": "GetRecords",
            "service": { "name": "dynamodb.amazonaws.com" },
          },
        "actor": { "user": { "uid": "arn:aws:test_arn" } },
        "metadata": { "event_code": "AwsApiCall" },
        "src_endpoint": { "ip": "111.111.111.111" },
        "unmapped": { "recipientAccountId": "123456789012" },
        "p_log_type": "OCSF.ApiActivity",
      }
  - ExpectedResult: true
    Name: Password Discovery ARN - OCSF
    Log:
      {
        "api":
          {
            "operation": "GetAccountPasswordPolicy",
            "service": { "name": "iam.amazonaws.com" },
          },
        "actor": { "user": { "uid": "arn:aws:test_arn" } },
        "metadata": { "event_code": "AwsApiCall" },
        "src_endpoint": { "ip": "111.111.111.111" },
        "unmapped": { "recipientAccountId": "123456789012" },
        "p_log_type": "OCSF.ApiActivity",
      }
DedupPeriodMinutes: 30
LogTypes:
  - AWS.CloudTrail
  - OCSF.ApiActivity
Tags:
  - DataModel
RuleID: AWS.CloudTrail.Password.Policy.Discovery
Threshold: 2
